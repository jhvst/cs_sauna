<!DOCTYPE html>
<html lang="en">
<head>
    <title>cs_sauna</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            display: grid;
            justify-items: center;
            gap: 2rem;
            grid-template-columns: repeat(2, 1fr)
        }

        video {
            width: 100%;
        }
    </style>
</head>  
<body>
    <p>cs_sauna is twitch but with better bitrate</p>
    <form onsubmit="addStream(event); return false">
        <fieldset>
            <legend>Follow players</legend>
            <input name="streamer" type="text" required />
            <button type="submit">Add</button>
        </fieldset>
    </form>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/0.14.17/hls.min.js" integrity="sha512-t0GMHzxvVdMw1p8oSntdvFKikEx9Pwus6G2PP3U7/GQ3+Id+D9sYgnck0etYk0CBK5gdk8BJBnQYx7PIT1PJ0Q==" crossorigin="anonymous"></script>
<script>

    const modifyStream = async (e) => {
        e.preventDefault();
    }

    const createVideo = async (name, video) => {
        const f = document.createElement("form");
        f.onsubmit = "modifyStream(event); return false";
        const fs = document.createElement("fieldset");
        const l = document.createElement("legend");
        l.innerText = name;
        const btn = document.createElement("button");
        btn.type = "submit"
        btn.innerText = "Remove stream"

        f.appendChild(fs)
        fs.appendChild(l)
        fs.appendChild(btn)
        fs.appendChild(video)

        document.body.appendChild(f)
    }

  const addStream = async (e) => {
      const streamer = new FormData(e.target).get("streamer")
      const shim = Hls.isSupported()
      const video = document.createElement("video")
      const modern = video.canPlayType('application/vnd.apple.mpegurl')
      const support = shim || modern;
      if (!support) {
          alert("No HLS support. Try Microsoft Edge or Chrome Canary.")
          return
      }

      if (modern) {
        video.src = 'http://hel1.ponkila.com:8000/' + streamer + '.m3u8';
        video.addEventListener('loadedmetadata',function() {
            video.play();
        });
        console.log("modern browser with native support")
        createVideo(streamer, video)
        return
      }

      if (shim) {
        const hls = new Hls();
        hls.loadSource('http://hel1.ponkila.com:8000/' + streamer + '.m3u8');
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, function() {
            video.play();
        });
        console.log("shim supported browser")
        createVideo(streamer, video)
        return
      }
  }
</script>
